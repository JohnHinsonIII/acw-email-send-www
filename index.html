<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACW Email Campaign Sender</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5f7c 0%, #1a4456 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: rgba(40, 167, 69, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(220, 53, 69, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .left-panel {
            padding: 40px;
            border-right: 1px solid #e0e0e0;
            background: #f9f9f9;
        }

        .right-panel {
            padding: 40px;
            background: white;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c5f7c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #d4af37;
            border-radius: 2px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #2c5f7c;
            box-shadow: 0 0 0 3px rgba(44, 95, 124, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .recipient-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .recipient-input input {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2c5f7c;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1a4456;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 95, 124, 0.3);
        }

        .btn-secondary {
            background: #d4af37;
            color: #2d2d2d;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #c09d2f;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .recipients-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: white;
            margin-top: 10px;
        }

        .recipient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .recipient-item span {
            font-size: 0.9rem;
        }

        .status-box {
            background: #f0f7ff;
            border: 2px solid #2c5f7c;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .status-box.show {
            display: block;
        }

        .status-box.success {
            background: #d4edda;
            border-color: #28a745;
        }

        .status-box.error {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .status-box h3 {
            margin-bottom: 10px;
            color: #2c5f7c;
        }

        .status-box.success h3 {
            color: #28a745;
        }

        .status-box.error h3 {
            color: #dc3545;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2c5f7c, #1a4456);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.3s ease;
            width: 0%;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #2c5f7c;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #2c5f7c;
            border-bottom-color: #d4af37;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .email-preview {
            width: 100%;
            height: 500px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .left-panel {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß ACW Email Campaign Sender</h1>
            <p>Professional Email Marketing with Backend Integration</p>
            <div class="connection-status" id="connection-status">
                <span id="status-text">Checking connection...</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Left Panel: Configuration -->
            <div class="left-panel">
                <!-- SMTP Settings Section -->
                <div class="section">
                    <div class="section-title">‚öôÔ∏è SMTP Configuration</div>
                    
                    <div class="input-group">
                        <label for="smtp-host">SMTP Host</label>
                        <input type="text" id="smtp-host" placeholder="smtp.gmail.com">
                        <p class="help-text">Example: smtp.gmail.com, smtp-mail.outlook.com</p>
                    </div>

                    <div class="input-group">
                        <label for="smtp-port">SMTP Port</label>
                        <select id="smtp-port">
                            <option value="587">587 (TLS)</option>
                            <option value="465">465 (SSL)</option>
                            <option value="25">25 (Standard)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="smtp-username">Username (Email)</label>
                        <input type="email" id="smtp-username" placeholder="your-email@gmail.com">
                    </div>

                    <div class="input-group">
                        <label for="smtp-password">Password / App Password</label>
                        <input type="password" id="smtp-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <p class="help-text">For Gmail, use an App Password, not your regular password</p>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveSMTPSettings()">Save Settings</button>
                        <button class="btn btn-secondary btn-small" onclick="testSMTP()">Test Connection</button>
                    </div>
                </div>

                <!-- Recipients Section -->
                <div class="section">
                    <div class="section-title">üë• Recipients</div>
                    
                    <div class="recipient-input">
                        <input type="text" id="recipient-name" placeholder="Name (optional)">
                        <input type="email" id="recipient-email" placeholder="Email Address">
                        <button class="btn btn-success btn-small" onclick="addRecipient()">Add</button>
                    </div>

                    <div class="btn-group">
                        <label for="csv-upload" class="btn btn-secondary btn-small" style="margin: 0; cursor: pointer;">
                            Import CSV
                            <input type="file" id="csv-upload" accept=".csv" style="display: none;" onchange="importCSV(event)">
                        </label>
                        <button class="btn btn-secondary btn-small" onclick="exportRecipients()">Export CSV</button>
                        <button class="btn btn-danger btn-small" onclick="clearRecipients()">Clear All</button>
                    </div>

                    <div id="recipients-list" class="recipients-list">
                        <p style="text-align: center; color: #999;">No recipients added yet</p>
                    </div>

                    <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <strong id="recipient-count">0</strong> recipients ready
                    </p>
                </div>
            </div>

            <!-- Right Panel: Email Composition -->
            <div class="right-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('compose', event)">‚úâÔ∏è Compose</button>
                    <button class="tab" onclick="switchTab('preview', event)">üëÅÔ∏è Preview</button>
                </div>

                <!-- Compose Tab -->
                <div id="compose-tab" class="tab-content active">
                    <div class="section">
                        <div class="input-group">
                            <label for="from-name">From Name</label>
                            <input type="text" id="from-name" placeholder="ACW Email Campaign">
                        </div>

                        <div class="input-group">
                            <label for="test-email">Test Email Address</label>
                            <input type="email" id="test-email" placeholder="test@example.com">
                            <p class="help-text">Send a test email to this address before bulk sending</p>
                        </div>

                        <div class="input-group">
                            <label for="subject">Email Subject</label>
                            <input type="text" id="subject" placeholder="Your Amazing Subject Line">
                        </div>

                        <div class="input-group">
                            <label for="landing-url">Landing Page URL</label>
                            <input type="text" id="landing-url" placeholder="https://your-landing-page.com">
                            <p class="help-text">Use [LANDING_PAGE_URL] in your HTML to insert this link</p>
                        </div>

                        <div class="input-group">
                            <label for="html-content">HTML Email Content</label>
                            <textarea id="html-content" placeholder="Paste your HTML email template here...

Available merge tags:
[First Name] - Recipient's first name
[LANDING_PAGE_URL] - Your landing page URL
[UNSUBSCRIBE_LINK] - Unsubscribe link"></textarea>
                            <p class="help-text">Paste your complete HTML email template</p>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="previewEmail()">Preview Email</button>
                            <button class="btn btn-primary" onclick="sendTestEmail()">Send Test</button>
                            <button class="btn btn-success" onclick="sendBulkEmails()" id="bulk-send-btn">
                                Send to All Recipients
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div id="preview-tab" class="tab-content">
                    <div class="section">
                        <p style="margin-bottom: 15px; color: #666;">Email preview with merge tags replaced:</p>
                        <iframe id="preview-frame" class="email-preview"></iframe>
                    </div>
                </div>

                <!-- Status Box -->
                <div id="status-box" class="status-box">
                    <h3 id="status-title">Status</h3>
                    <p id="status-message"></p>
                </div>

                <!-- Progress Bar -->
                <div id="progress-container" class="progress-bar">
                    <div id="progress-fill" class="progress-fill">0%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = window.location.origin + '/api';
        
        // State
        let recipients = [];
        let smtpSettings = {};

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            checkServerConnection();
            loadRecipients();
            loadSMTPSettings();
        });

        // Check server connection
        async function checkServerConnection() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                const statusEl = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');
                
                if (data.status === 'ok') {
                    statusEl.className = 'connection-status connected';
                    statusText.textContent = `‚úÖ Connected ${data.smtpConfigured ? '‚Ä¢ SMTP Ready' : '‚Ä¢ Configure SMTP'}`;
                } else {
                    statusEl.className = 'connection-status disconnected';
                    statusText.textContent = '‚ùå Server Error';
                }
            } catch (error) {
                const statusEl = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');
                statusEl.className = 'connection-status disconnected';
                statusText.textContent = '‚ùå Server Offline';
                showStatus('error', 'Cannot connect to server. Make sure the backend is running.');
            }
        }

        // Tab switching
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Recipient management
        function addRecipient() {
            const name = document.getElementById('recipient-name').value.trim();
            const email = document.getElementById('recipient-email').value.trim();

            if (!email) {
                showStatus('error', 'Please enter an email address');
                return;
            }

            if (!validateEmail(email)) {
                showStatus('error', 'Please enter a valid email address');
                return;
            }

            if (recipients.some(r => r.email === email)) {
                showStatus('error', 'This email is already in the list');
                return;
            }

            recipients.push({ name: name || 'Friend', email: email });
            updateRecipientsList();
            saveRecipients();

            document.getElementById('recipient-name').value = '';
            document.getElementById('recipient-email').value = '';
        }

        function removeRecipient(index) {
            recipients.splice(index, 1);
            updateRecipientsList();
            saveRecipients();
        }

        function updateRecipientsList() {
            const listDiv = document.getElementById('recipients-list');
            const countEl = document.getElementById('recipient-count');
            
            countEl.textContent = recipients.length;

            if (recipients.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999;">No recipients added yet</p>';
                return;
            }

            listDiv.innerHTML = recipients.map((recipient, index) => `
                <div class="recipient-item">
                    <span><strong>${recipient.name}</strong> - ${recipient.email}</span>
                    <button class="btn btn-danger btn-small" onclick="removeRecipient(${index})">Remove</button>
                </div>
            `).join('');
        }

        function clearRecipients() {
            if (!confirm('Are you sure you want to clear all recipients?')) return;
            recipients = [];
            updateRecipientsList();
            saveRecipients();
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                let imported = 0;

                lines.forEach(line => {
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 2 && parts[1]) {
                        const name = parts[0] || 'Friend';
                        const email = parts[1];
                        
                        if (validateEmail(email) && !recipients.some(r => r.email === email)) {
                            recipients.push({ name, email });
                            imported++;
                        }
                    }
                });

                updateRecipientsList();
                saveRecipients();
                showStatus('success', `Imported ${imported} recipients successfully!`);
            };
            reader.readAsText(file);
        }

        function exportRecipients() {
            if (recipients.length === 0) {
                showStatus('error', 'No recipients to export');
                return;
            }

            const csv = recipients.map(r => `${r.name},${r.email}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'recipients.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // SMTP Settings
        async function saveSMTPSettings() {
            smtpSettings = {
                host: document.getElementById('smtp-host').value,
                port: document.getElementById('smtp-port').value,
                username: document.getElementById('smtp-username').value,
                password: document.getElementById('smtp-password').value
            };

            if (!smtpSettings.host || !smtpSettings.username || !smtpSettings.password) {
                showStatus('error', 'Please fill in all SMTP settings');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/update-smtp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(smtpSettings)
                });

                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('smtpSettings', JSON.stringify(smtpSettings));
                    showStatus('success', 'SMTP settings saved successfully!');
                    checkServerConnection();
                } else {
                    showStatus('error', data.message);
                }
            } catch (error) {
                showStatus('error', `Failed to save SMTP settings: ${error.message}`);
            }
        }

        function loadSMTPSettings() {
            const saved = localStorage.getItem('smtpSettings');
            if (saved) {
                smtpSettings = JSON.parse(saved);
                document.getElementById('smtp-host').value = smtpSettings.host || '';
                document.getElementById('smtp-port').value = smtpSettings.port || '587';
                document.getElementById('smtp-username').value = smtpSettings.username || '';
                document.getElementById('smtp-password').value = smtpSettings.password || '';
            }
        }

        async function testSMTP() {
            const settings = {
                host: document.getElementById('smtp-host').value,
                port: document.getElementById('smtp-port').value,
                username: document.getElementById('smtp-username').value,
                password: document.getElementById('smtp-password').value
            };

            if (!settings.host || !settings.username || !settings.password) {
                showStatus('error', 'Please fill in all SMTP settings');
                return;
            }

            showStatus('info', 'Testing SMTP connection...');

            try {
                const response = await fetch(`${API_URL}/test-smtp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.success) {
                    showStatus('success', data.message);
                } else {
                    showStatus('error', data.message);
                }
            } catch (error) {
                showStatus('error', `SMTP test failed: ${error.message}`);
            }
        }

        // Email operations
        function previewEmail() {
            const htmlContent = document.getElementById('html-content').value;
            const landingUrl = document.getElementById('landing-url').value;
            
            if (!htmlContent) {
                showStatus('error', 'Please paste your HTML email content first');
                return;
            }

            let processedHTML = htmlContent
                .replace(/\[First Name\]/g, 'Preview User')
                .replace(/\[LANDING_PAGE_URL\]/g, landingUrl || 'https://example.com')
                .replace(/\[UNSUBSCRIBE_LINK\]/g, '#unsubscribe');

            const iframe = document.getElementById('preview-frame');
            iframe.srcdoc = processedHTML;
            
            showStatus('success', 'Email preview loaded!');
        }

        async function sendTestEmail() {
            const testEmail = document.getElementById('test-email').value;
            const subject = document.getElementById('subject').value;
            const htmlContent = document.getElementById('html-content').value;
            const landingUrl = document.getElementById('landing-url').value;

            if (!testEmail || !subject || !htmlContent) {
                showStatus('error', 'Please fill in test email, subject, and HTML content');
                return;
            }

            showStatus('info', 'Sending test email...');

            try {
                const response = await fetch(`${API_URL}/send-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: testEmail,
                        subject: subject,
                        htmlContent: htmlContent,
                        landingUrl: landingUrl
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showStatus('success', `‚úÖ ${data.message}`);
                } else {
                    showStatus('error', data.message);
                }
            } catch (error) {
                showStatus('error', `Failed to send test email: ${error.message}`);
            }
        }

        async function sendBulkEmails() {
            if (recipients.length === 0) {
                showStatus('error', 'Please add at least one recipient');
                return;
            }

            const subject = document.getElementById('subject').value;
            const htmlContent = document.getElementById('html-content').value;
            const landingUrl = document.getElementById('landing-url').value;
            const fromName = document.getElementById('from-name').value;

            if (!subject || !htmlContent) {
                showStatus('error', 'Please fill in subject and HTML content');
                return;
            }

            if (!confirm(`Are you sure you want to send emails to ${recipients.length} recipients?`)) {
                return;
            }

            const bulkBtn = document.getElementById('bulk-send-btn');
            bulkBtn.disabled = true;
            bulkBtn.textContent = 'Sending...';

            showStatus('info', `Sending bulk emails to ${recipients.length} recipients...`);
            showProgress(0, recipients.length);

            try {
                const response = await fetch(`${API_URL}/send-bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipients: recipients,
                        subject: subject,
                        htmlContent: htmlContent,
                        landingUrl: landingUrl,
                        fromName: fromName
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showProgress(data.results.sent, recipients.length);
                    
                    let message = `‚úÖ Campaign completed!<br><br>`;
                    message += `‚úâÔ∏è Sent: ${data.results.sent}<br>`;
                    message += `‚ùå Failed: ${data.results.failed}<br>`;
                    
                    if (data.results.errors.length > 0) {
                        message += `<br><strong>Errors:</strong><br>`;
                        data.results.errors.slice(0, 5).forEach(err => {
                            message += `‚Ä¢ ${err.email}: ${err.error}<br>`;
                        });
                    }
                    
                    showStatus('success', message);
                } else {
                    showStatus('error', data.message);
                }
            } catch (error) {
                showStatus('error', `Bulk sending failed: ${error.message}`);
            } finally {
                bulkBtn.disabled = false;
                bulkBtn.textContent = 'Send to All Recipients';
            }
        }

        // Local storage
        function saveRecipients() {
            localStorage.setItem('emailRecipients', JSON.stringify(recipients));
        }

        function loadRecipients() {
            const saved = localStorage.getItem('emailRecipients');
            if (saved) {
                recipients = JSON.parse(saved);
                updateRecipientsList();
            }
        }

        // Utilities
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showStatus(type, message) {
            const statusBox = document.getElementById('status-box');
            const statusTitle = document.getElementById('status-title');
            const statusMessage = document.getElementById('status-message');

            statusBox.className = 'status-box show ' + type;
            
            if (type === 'success') {
                statusTitle.textContent = '‚úÖ Success';
            } else if (type === 'error') {
                statusTitle.textContent = '‚ùå Error';
            } else {
                statusTitle.textContent = '‚ÑπÔ∏è Info';
            }

            statusMessage.innerHTML = message;
        }

        function showProgress(current, total) {
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            
            progressContainer.classList.add('show');
            const percentage = Math.round((current / total) * 100);
            progressFill.style.width = percentage + '%';
            progressFill.textContent = `${current}/${total} (${percentage}%)`;
        }
    </script>
</body>
</html>
